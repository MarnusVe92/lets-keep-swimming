<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="app-version" content="2.6">
  <title>Let's Keep Swimming - Midmar Mile Training</title>

  <!-- Favicon & PWA -->
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
  <link rel="manifest" href="manifest.json">

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#3b82f6">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Keep Swimming">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="description" content="Your Midmar Mile Training Companion - Track sessions, get AI coaching, and connect with friends">

  <!-- Inter Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <link rel="stylesheet" href="styles.css">

  <!-- Chart.js for beautiful visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

  <!-- QR Code library for friend sharing -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- Version config (must load early) -->
  <script src="version.js"></script>
</head>
<body>
  <script>console.log('ðŸ“¦ Let\'s Keep Swimming - Version ' + (window.APP_VERSION?.version || '2.7'));</script>

  <!-- Update Available Banner -->
  <div id="update-banner" class="update-banner" style="display: none;">
    <div class="update-banner-content">
      <div class="update-banner-icon">
        <svg class="icon" viewBox="0 0 24 24"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
      </div>
      <div class="update-banner-text">
        <strong>Update Available</strong>
        <span id="update-changelog">New features and improvements</span>
      </div>
      <div class="update-banner-actions">
        <button id="update-dismiss-btn" class="btn btn-secondary btn-small">Later</button>
        <button id="update-refresh-btn" class="btn btn-primary btn-small">
          <span id="update-btn-text">Refresh</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Authentication Landing Page (shown before sign-in) -->
  <div id="auth-landing" class="auth-landing">
    <div class="auth-landing-content">
      <div class="auth-landing-header">
        <svg class="auth-landing-icon" viewBox="0 0 24 24">
          <path d="M12 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/>
          <path d="M4 22c2-2.5 4-4 6-4 1.5 0 2.5.5 4 1.5 1.5 1 2.5 1.5 4 1.5 2 0 4-1.5 6-4"/>
          <path d="M4 17c2-2.5 4-4 6-4 1.5 0 2.5.5 4 1.5 1.5 1 2.5 1.5 4 1.5 2 0 4-1.5 6-4"/>
          <path d="M7 14l3.5-3.5L13 13l4-6"/>
        </svg>
        <h1>Let's Keep Swimming</h1>
        <p class="auth-landing-subtitle">Your Midmar Mile Training Companion</p>
      </div>

      <div class="auth-landing-card">
        <h2>Welcome</h2>
        <p class="auth-landing-description">Sign in to track your training, get AI coaching, and connect with friends</p>

        <div id="auth-error" class="auth-error" style="display: none;"></div>

        <!-- Sign In Options -->
        <div class="auth-options">
          <button id="landing-google-btn" class="btn btn-primary btn-large auth-btn">
            <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
              <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
          </button>

          <div class="auth-divider">
            <span>or</span>
          </div>

          <button id="landing-email-btn" class="btn btn-secondary btn-large auth-btn">
            <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
              <polyline points="22,6 12,13 2,6"/>
            </svg>
            Continue with Email
          </button>
        </div>

        <!-- Email Sign In Form (hidden by default) -->
        <div id="email-auth-form" class="email-auth-form" style="display: none;">
          <div class="auth-form-tabs">
            <button id="signin-tab" class="auth-tab active">Sign In</button>
            <button id="signup-tab" class="auth-tab">Sign Up</button>
          </div>

          <form id="email-signin-form" class="auth-form">
            <div class="form-group">
              <label for="signin-email">Email</label>
              <input type="email" id="signin-email" required placeholder="your@email.com">
            </div>
            <div class="form-group">
              <label for="signin-password">Password</label>
              <input type="password" id="signin-password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div style="text-align: right; margin-bottom: var(--spacing-md);">
              <button type="button" id="forgot-password-btn" class="btn-link" style="font-size: 0.875rem;">Forgot password?</button>
            </div>
            <button type="submit" class="btn btn-primary btn-large">Sign In</button>
            <button type="button" id="back-to-options-btn" class="btn btn-text">Back to options</button>
          </form>

          <form id="email-signup-form" class="auth-form" style="display: none;">
            <div class="form-group">
              <label for="signup-name">Display Name</label>
              <input type="text" id="signup-name" required placeholder="Your name">
            </div>
            <div class="form-group">
              <label for="signup-email">Email</label>
              <input type="email" id="signup-email" required placeholder="your@email.com">
            </div>
            <div class="form-group">
              <label for="signup-password">Password</label>
              <input type="password" id="signup-password" required minlength="6" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
              <small>At least 6 characters</small>
            </div>
            <button type="submit" class="btn btn-primary btn-large">Create Account</button>
            <button type="button" id="back-to-options-btn-2" class="btn btn-text">Back to options</button>
          </form>

          <form id="forgot-password-form" class="auth-form" style="display: none;">
            <p style="margin-bottom: var(--spacing-lg); color: var(--text-secondary);">
              Enter your email address and we'll send you a link to reset your password.
            </p>
            <div class="form-group">
              <label for="forgot-email">Email</label>
              <input type="email" id="forgot-email" required placeholder="your@email.com">
            </div>
            <button type="submit" class="btn btn-primary btn-large">Send Reset Link</button>
            <button type="button" id="back-to-signin-btn" class="btn btn-text">Back to sign in</button>
          </form>
        </div>
      </div>

      <div class="auth-landing-features">
        <div class="feature-item">
          <svg class="feature-icon" viewBox="0 0 24 24"><path d="M12 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path d="M4 22c2-2.5 4-4 6-4 1.5 0 2.5.5 4 1.5 1.5 1 2.5 1.5 4 1.5 2 0 4-1.5 6-4"/></svg>
          <span>Track your training</span>
        </div>
        <div class="feature-item">
          <svg class="feature-icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <span>AI coaching</span>
        </div>
        <div class="feature-item">
          <svg class="feature-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/></svg>
          <span>Connect with friends</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App (hidden until authenticated) -->
  <div id="main-app" style="display: none;">
  <!-- Combined Header + Navigation -->
  <header class="header" id="main-header">
    <div class="container header-content">
      <!-- Brand (always visible) -->
      <div class="header-brand">
        <svg class="icon icon-outline brand-icon" viewBox="0 0 24 24">
          <path d="M12 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/>
          <path d="M4 22c2-2.5 4-4 6-4 1.5 0 2.5.5 4 1.5 1.5 1 2.5 1.5 4 1.5 2 0 4-1.5 6-4"/>
          <path d="M4 17c2-2.5 4-4 6-4 1.5 0 2.5.5 4 1.5 1.5 1 2.5 1.5 4 1.5 2 0 4-1.5 6-4"/>
          <path d="M7 14l3.5-3.5L13 13l4-6"/>
        </svg>
        <div class="brand-text">
          <h1 class="app-title">Let's Keep Swimming</h1>
          <p class="app-subtitle">Midmar Mile Training Companion</p>
        </div>
      </div>

      <!-- Desktop Navigation (hidden on mobile) -->
      <nav class="nav-desktop">
        <div class="nav-group nav-group-primary">
          <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
          <button class="tab-btn" data-tab="sessions">Sessions</button>
          <button class="tab-btn" data-tab="coach">Coach</button>
          <button class="tab-btn" data-tab="social">Social</button>
        </div>
        <div class="nav-group nav-group-secondary">
          <button class="tab-btn tab-btn-profile" data-tab="profile">
            <span class="nav-avatar" id="nav-avatar">
              <span class="avatar-placeholder" id="avatar-placeholder">
                <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              </span>
              <img src="" alt="Profile" class="avatar-image" id="avatar-image" style="display: none;" referrerpolicy="no-referrer">
            </span>
            Profile
          </button>
          <button class="tab-btn" data-tab="data">Data</button>
        </div>
      </nav>

      <!-- Mobile Profile Button (opens dropdown) -->
      <button class="mobile-profile-btn" id="mobile-profile-btn" aria-label="Profile menu" aria-expanded="false">
        <span class="mobile-profile-avatar" id="mobile-profile-avatar">
          <svg class="icon icon-outline" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
        </span>
        <span class="notification-badge" id="friend-request-badge" style="display: none;">0</span>
      </button>
    </div>
  </header>

  <!-- Mobile Profile Dropdown (slides down from header) -->
  <div class="mobile-profile-dropdown" id="mobile-profile-dropdown">
    <div class="mobile-profile-dropdown-content">
      <!-- Friend Requests (shown when there are pending requests) -->
      <button class="mobile-profile-dropdown-btn friend-requests-btn" id="mobile-friend-requests-btn" data-tab="social" style="display: none;">
        <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
        <span>Friend Requests</span>
        <span class="dropdown-badge" id="mobile-dropdown-badge">0</span>
        <svg class="icon icon-outline icon-chevron" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
      <button class="mobile-profile-dropdown-btn" data-tab="profile">
        <svg class="icon icon-outline" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
        <span>Profile Settings</span>
        <svg class="icon icon-outline icon-chevron" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
      <button class="mobile-profile-dropdown-btn" data-tab="data">
        <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <span>Import / Export Data</span>
        <svg class="icon icon-outline icon-chevron" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
    </div>
  </div>
  <div class="mobile-profile-overlay" id="mobile-profile-overlay"></div>

  <!-- Mobile Bottom Navigation Bar -->
  <nav class="mobile-bottom-nav" id="mobile-bottom-nav">
    <button class="mobile-bottom-nav-btn active" data-tab="dashboard">
      <svg class="icon icon-outline" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      <span>Home</span>
    </button>
    <button class="mobile-bottom-nav-btn" data-tab="sessions">
      <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M12 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path d="M4 22c2-2.5 4-4 6-4 1.5 0 2.5.5 4 1.5 1.5 1 2.5 1.5 4 1.5 2 0 4-1.5 6-4"/><path d="M4 17c2-2.5 4-4 6-4 1.5 0 2.5.5 4 1.5 1.5 1 2.5 1.5 4 1.5 2 0 4-1.5 6-4"/></svg>
      <span>Training</span>
    </button>
    <button class="mobile-bottom-nav-btn" data-tab="coach">
      <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      <span>Coach</span>
    </button>
    <button class="mobile-bottom-nav-btn" data-tab="social">
      <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      <span>Social</span>
    </button>
  </nav>

  <main class="container">
    <!-- ============================================ -->
    <!-- DASHBOARD TAB -->
    <!-- ============================================ -->
    <section id="tab-dashboard" class="tab-content active">
      <h2 class="section-title">Training Dashboard</h2>

      <!-- Event Countdown Card -->
      <div class="card card-primary">
        <div class="card-header">
          <h3>
            <svg class="icon icon-outline" viewBox="0 0 24 24" style="color: white;"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
            Event Countdown
          </h3>
        </div>
        <div class="card-body">
          <div id="countdown-display" class="countdown">
            <div class="countdown-number">--</div>
            <div class="countdown-label">days until Midmar Mile</div>
          </div>
          <div class="countdown-actions">
            <button onclick="switchTab('sessions')" class="btn btn-countdown">
              <svg class="icon icon-outline" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Log Session
            </button>
            <button onclick="switchTab('coach')" class="btn btn-countdown">
              <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              View Coach
            </button>
          </div>
        </div>
      </div>

      <!-- Training Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M16 4h2a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-2"/><path d="M8 20H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 4v16"/><path d="M12 4h4"/><path d="M12 8h3"/><path d="M12 12h4"/><path d="M12 16h3"/><path d="M12 20h4"/></svg>
          </div>
          <div class="stat-value" id="stat-7days">-- m</div>
          <div class="stat-label">Last 7 Days</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <svg class="icon icon-outline" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
          </div>
          <div class="stat-value" id="stat-14days">-- m</div>
          <div class="stat-label">Last 14 Days</div>
        </div>

        <div class="stat-card" title="Shows the most common effort level from your sessions in the last 7 days. Easy, Moderate, or Hard.">
          <div class="stat-icon">
            <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M6.5 6.5a2.5 2.5 0 0 1 5 0v11a2.5 2.5 0 0 1-5 0v-11z"/><path d="M12.5 6.5a2.5 2.5 0 0 1 5 0v11a2.5 2.5 0 0 1-5 0v-11z"/><line x1="4" y1="12" x2="6.5" y2="12"/><line x1="17.5" y1="12" x2="20" y2="12"/></svg>
          </div>
          <div class="stat-value" id="stat-avg-rpe">--</div>
          <div class="stat-label">Typical Effort</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">
            <svg class="icon icon-outline" viewBox="0 0 24 24" style="color: var(--color-warning);"><path d="M12 22c4.97 0 9-3.58 9-8 0-2.5-.5-4-2-6-1-1.5-2-3-2-5 0 0-1.5 1-2 3-.5 2-2 3-4 3s-4-1.5-4-3.5c0-1.5.5-3 1-4C6 4 4 7 4 10c0 6 4 12 8 12z"/></svg>
          </div>
          <div class="stat-value" id="stat-streak">--</div>
          <div class="stat-label">Current Streak</div>
          <div class="streak-history" id="streak-history">
            <span class="streak-best">Best: <strong id="streak-best-value">--</strong> days</span>
            <span class="streak-dates" id="streak-best-dates"></span>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="charts-row">
        <div class="card">
          <div class="card-header">
            <h3>Training Volume (Last 14 Days)</h3>
          </div>
          <div class="card-body">
            <canvas id="volumeChart"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Training Progress</h3>
          </div>
          <div class="card-body">
            <canvas id="progressChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Weekly Goals Progress -->
      <div class="card">
        <div class="card-header">
          <h3>
            <svg class="icon icon-outline" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
            This Week's Progress
          </h3>
        </div>
        <div class="card-body">
          <div id="weekly-goals-container">
            <div class="goal-card">
              <div class="goal-header">
                <span class="goal-title">Weekly Distance Target</span>
                <span class="goal-progress-text" id="goal-distance-text">-- / -- m</span>
              </div>
              <div class="goal-progress-bar">
                <div class="goal-progress-fill on-track" id="goal-distance-fill" style="width: 0%"></div>
              </div>
              <div class="goal-remaining">
                <span>Remaining: <strong id="goal-distance-remaining">--</strong></span>
                <span id="goal-distance-status">Set up profile to see goals</span>
              </div>
            </div>

            <div class="goal-card">
              <div class="goal-header">
                <span class="goal-title">Sessions This Week</span>
                <span class="goal-progress-text" id="goal-sessions-text">-- / --</span>
              </div>
              <div class="goal-progress-bar">
                <div class="goal-progress-fill on-track" id="goal-sessions-fill" style="width: 0%"></div>
              </div>
              <div class="goal-remaining">
                <span>Remaining: <strong id="goal-sessions-remaining">--</strong></span>
                <span id="goal-sessions-status"></span>
              </div>
            </div>

            <!-- 10-Week History Rings -->
            <div class="week-history">
              <div class="week-history-header">
                <span class="goal-title">10-Week History</span>
                <span class="week-history-legend">
                  <span class="legend-item"><span class="legend-dot complete"></span>100%+</span>
                  <span class="legend-item"><span class="legend-dot partial"></span>50-99%</span>
                  <span class="legend-item"><span class="legend-dot low"></span>&lt;50%</span>
                </span>
              </div>
              <div class="week-rings" id="week-rings">
                <!-- Rings will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Sessions -->
      <div class="card">
        <div class="card-header">
          <h3>Recent Sessions</h3>
        </div>
        <div class="card-body">
          <div id="recent-sessions-list"></div>
        </div>
      </div>

    </section>

    <!-- ============================================ -->
    <!-- COACH TAB -->
    <!-- ============================================ -->
    <section id="tab-coach" class="tab-content">
      <h2 class="section-title">AI Coach</h2>

      <!-- Coach Status -->
      <div class="coach-status" id="coach-status">
        <span class="coach-status-dot none" id="coach-status-dot"></span>
        <span id="coach-status-text">No recommendation yet</span>
      </div>

      <!-- Get New Recommendation -->
      <div class="card">
        <div class="card-header">
          <h3>Get Tomorrow's Session</h3>
        </div>
        <div class="card-body">
          <p style="margin-bottom: var(--spacing-md); color: var(--color-text-muted);">
            Based on your profile and recent training, the AI coach will recommend your next session.
          </p>
          <button id="get-coaching-btn" class="btn btn-primary btn-large">
            <svg class="icon icon-outline" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Generate New Recommendation
          </button>
          <div id="coaching-loading" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
            <p>Consulting your AI coach...</p>
          </div>
        </div>
      </div>

      <!-- Current Recommendation -->
      <div id="coaching-results" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h3>Tomorrow's Session</h3>
            <div class="card-header-actions">
              <button id="copy-coaching-btn" class="btn btn-secondary btn-small">
                <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                Copy
              </button>
            </div>
          </div>
          <div class="card-body">
            <!-- Adjustment Controls -->
            <div class="coach-adjustments" id="coach-adjustments">
              <div class="adjustment-group">
                <label>Type</label>
                <div class="toggle-group">
                  <button class="toggle-btn active" data-type="pool" id="toggle-pool">
                    <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M2 14h20"/><path d="M6 6v12"/><path d="M10 6v12"/><path d="M14 6v12"/><path d="M18 6v12"/></svg>
                    Pool
                  </button>
                  <button class="toggle-btn" data-type="open_water" id="toggle-openwater">
                    <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M2 12c2-2 4-3 6-3s4 1 6 3 4 3 6 3 4-1 6-3"/><path d="M2 6c2-2 4-3 6-3s4 1 6 3 4 3 6 3 4-1 6-3"/><path d="M2 18c2-2 4-3 6-3s4 1 6 3 4 3 6 3 4-1 6-3"/></svg>
                    Open Water
                  </button>
                </div>
              </div>
              <div class="adjustment-group">
                <label for="adjust-distance">Distance (m)</label>
                <input type="number" id="adjust-distance" min="100" max="10000" step="100" class="adjust-input">
              </div>
              <button id="adapt-session-btn" class="btn btn-secondary">
                <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                Adapt Session
              </button>
            </div>

            <div id="coaching-display"></div>

            <!-- Log Session from Coach -->
            <div class="coach-commit" id="coach-commit">
              <button id="log-from-coach-btn" class="btn btn-primary btn-large">
                <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><polyline points="20 6 9 17 4 12"/></svg>
                Log This Session
              </button>
              <p class="text-muted">Mark this session as completed and add it to your training log</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div id="coach-empty-state" class="card">
        <div class="card-body">
          <div class="empty-state">
            <div class="empty-state-icon">
              <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7z"/></svg>
            </div>
            <p>Click the button above to get your first recommendation!</p>
            <p class="text-muted" style="margin-top: var(--spacing-sm);">
              The coach uses your profile and training history to create personalized sessions.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- ============================================ -->
    <!-- PROFILE TAB -->
    <!-- ============================================ -->
    <!-- ============================================ -->
    <!-- PROFILE TAB - Reorganized -->
    <!-- ============================================ -->
    <section id="tab-profile" class="tab-content">
      <h2 class="section-title">Profile</h2>

      <!-- Main Profile Form Wrapper -->
      <form id="profile-form">

      <!-- Profile Summary Card -->
      <div class="card">
        <div class="card-body">
          <div class="profile-summary">
            <div class="profile-summary-avatar" id="profile-summary-avatar">
              <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <div class="profile-summary-info">
              <h3 id="profile-summary-name">Loading...</h3>
              <p class="profile-summary-email" id="profile-summary-email">---</p>
              <div class="profile-summary-badges">
                <span class="badge badge-success" id="email-verified-badge" style="display: none;">
                  <svg class="icon" viewBox="0 0 24 24" style="width: 14px; height: 14px;"><polyline points="20 6 9 17 4 12"/></svg>
                  Email Verified
                </span>
                <span class="badge badge-warning" id="email-unverified-badge" style="display: none;">
                  <svg class="icon" viewBox="0 0 24 24" style="width: 14px; height: 14px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                  Email Not Verified
                  <button id="resend-verification-btn" class="btn-link">Resend</button>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Personal Details -->
      <div class="card collapsible-card">
        <div class="card-header collapsible-header" data-target="personal-details-content">
          <h3>
            <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            Personal Details
          </h3>
          <svg class="icon icon-outline chevron-icon" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
        </div>
        <div class="card-body collapsible-content" id="personal-details-content">
          <div id="personal-details-form-content">
            <!-- Profile Picture -->
            <div class="form-group profile-picture-section">
              <label>Profile Picture</label>
              <div class="profile-picture-upload">
                <div class="profile-picture-preview" id="profile-picture-preview">
                  <div class="profile-picture-placeholder" id="profile-picture-placeholder">
                    <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                  </div>
                  <img src="" alt="Profile Picture" class="profile-picture-img" id="profile-picture-img" style="display: none;" referrerpolicy="no-referrer">
                </div>
                <div class="profile-picture-actions">
                  <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
                  <button type="button" class="btn btn-secondary btn-small" id="upload-picture-btn">
                    <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Upload Photo
                  </button>
                  <button type="button" class="btn btn-secondary btn-small" id="remove-picture-btn" style="display: none;">
                    <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                    Remove
                  </button>
                </div>
              </div>
              <small>This will appear next to your profile in the navigation</small>
            </div>

            <!-- Name -->
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" name="firstName" placeholder="Your first name">
              </div>
              <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" name="lastName" placeholder="Your last name">
              </div>
            </div>

            <!-- Birth Year & Gender -->
            <div class="form-row">
              <div class="form-group">
                <label for="birthYear">Birth Year</label>
                <input type="number" id="birthYear" name="birthYear" min="1920" max="2020" placeholder="e.g. 1990">
                <small>Used for age-appropriate training recommendations</small>
              </div>
              <div class="form-group">
                <label for="gender">Gender</label>
                <select id="gender" name="gender">
                  <option value="">Prefer not to say</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                </select>
                <small>Optional - helps tailor training recommendations</small>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Training Requirements -->
      <div class="card collapsible-card">
        <div class="card-header collapsible-header" data-target="training-requirements-content">
          <h3>
            <svg class="icon icon-outline" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            Training Requirements
          </h3>
          <svg class="icon icon-outline chevron-icon" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
        </div>
        <div class="card-body collapsible-content collapsed" id="training-requirements-content">
          <div id="training-requirements-form-content">
            <!-- Training Availability -->
            <div class="form-group">
              <label>Training Availability</label>
              <div class="availability-options">
                <div class="option-group">
                  <input type="radio" id="avail-days" name="availability-type" value="days" checked>
                  <label for="avail-days">Specific days</label>
                </div>
                <div class="option-group">
                  <input type="radio" id="avail-sessions" name="availability-type" value="sessions">
                  <label for="avail-sessions">Sessions per week</label>
                </div>
              </div>
            </div>

            <!-- Days checkboxes -->
            <div class="form-group" id="days-group">
              <label>Which days can you train?</label>
              <div class="checkbox-group">
                <label><input type="checkbox" name="day" value="Mon"> Mon</label>
                <label><input type="checkbox" name="day" value="Tue"> Tue</label>
                <label><input type="checkbox" name="day" value="Wed"> Wed</label>
                <label><input type="checkbox" name="day" value="Thu"> Thu</label>
                <label><input type="checkbox" name="day" value="Fri"> Fri</label>
                <label><input type="checkbox" name="day" value="Sat"> Sat</label>
                <label><input type="checkbox" name="day" value="Sun"> Sun</label>
              </div>
            </div>

            <!-- Sessions per week -->
            <div class="form-group" id="sessions-group" style="display: none;">
              <label for="sessionsPerWeek">Sessions per week</label>
              <input type="number" id="sessionsPerWeek" name="sessionsPerWeek" min="1" max="7" value="3">
            </div>

            <!-- Access -->
            <div class="form-group">
              <label>Access to Training Facilities</label>
              <div class="checkbox-group">
                <label><input type="checkbox" id="access-pool" name="access-pool" checked> Pool</label>
                <label><input type="checkbox" id="access-ow" name="access-ow"> Open Water</label>
              </div>
            </div>

            <!-- Longest Recent Swim -->
            <div class="form-row">
              <div class="form-group">
                <label for="longestDistance">Longest Recent Swim (meters)</label>
                <input type="number" id="longestDistance" name="longestDistance" min="0" step="100" value="1000" required>
              </div>
              <div class="form-group">
                <label for="longestTime">Time (minutes)</label>
                <input type="number" id="longestTime" name="longestTime" min="0" step="5" value="30" required>
              </div>
            </div>

            <!-- Weekly Volume -->
            <div class="form-group">
              <label for="weeklyVolume">Estimated Weekly Volume (meters)</label>
              <input type="number" id="weeklyVolume" name="weeklyVolume" min="0" step="500" value="3000" required>
              <small>How much do you typically swim per week?</small>
            </div>

          </div>
        </div>
      </div>

      <!-- Coaching Options -->
      <div class="card collapsible-card">
        <div class="card-header collapsible-header" data-target="coaching-options-content">
          <h3>
            <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            Coaching Options
          </h3>
          <svg class="icon icon-outline chevron-icon" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
        </div>
        <div class="card-body collapsible-content collapsed" id="coaching-options-content">
          <div id="coaching-options-form-content">
            <!-- Coaching Tone -->
            <div class="form-group">
              <label for="tone">Coaching Tone</label>
              <select id="tone" name="tone" required>
                <option value="neutral">Neutral (professional & factual)</option>
                <option value="calm">Calm (gentle & encouraging)</option>
                <option value="tough_love">Tough Love (direct & motivating)</option>
              </select>
            </div>

          </div>
        </div>
      </div>

      <!-- Privacy Settings -->
      <div class="card">
        <div class="card-header">
          <h3>
            <svg class="icon icon-outline" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            Privacy Settings
          </h3>
        </div>
        <div class="card-body">
          <p class="text-muted" style="margin-bottom: var(--spacing-lg);">Control what information you share with friends and the community.</p>
          <div class="privacy-toggles">
            <label class="toggle-switch">
              <input type="checkbox" id="privacy-share-volume" checked>
              <span class="toggle-slider"></span>
              <span class="toggle-label">Share weekly distance with friends</span>
            </label>
            <label class="toggle-switch">
              <input type="checkbox" id="privacy-share-streak" checked>
              <span class="toggle-slider"></span>
              <span class="toggle-label">Share current streak with friends</span>
            </label>
            <label class="toggle-switch">
              <input type="checkbox" id="privacy-share-pace">
              <span class="toggle-slider"></span>
              <span class="toggle-label">Share pace data with friends</span>
            </label>
            <div class="privacy-divider"></div>
            <label class="toggle-switch">
              <input type="checkbox" id="privacy-contribute-anonymous" checked>
              <span class="toggle-slider"></span>
              <span class="toggle-label">Contribute anonymous data to benchmarks</span>
            </label>
          </div>
          <p class="text-muted" style="margin-top: var(--spacing-md);">
            <small>Your personal info is never shared. Friends only see stats you allow.</small>
          </p>
        </div>
      </div>

      <!-- Floating Save Bar -->
      <div id="profile-save-bar" class="floating-save-bar" style="display: none;">
        <div class="save-bar-content">
          <span class="save-bar-message">You have unsaved changes</span>
          <div class="save-bar-actions">
            <button type="button" class="btn btn-secondary btn-small" id="profile-discard-btn">Discard</button>
            <button type="submit" class="btn btn-primary btn-small" id="profile-save-btn">Save Changes</button>
          </div>
        </div>
      </div>

      </form> <!-- End profile-form -->

      <!-- Account Management -->
      <div class="card">
        <div class="card-header">
          <h3>
            <svg class="icon icon-outline" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m5.196-13.196L13 9l-4.196 4.196m0-6.392L13 15l4.196 4.196m6.392-4.196H17m-6 0H5"/></svg>
            Account Management
          </h3>
        </div>
        <div class="card-body">
          <div class="account-actions">
            <button id="sign-out-profile-btn" class="btn btn-secondary">
              <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
              Sign Out
            </button>
            <button id="delete-account-btn" class="btn btn-danger">
              <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              Delete Account
            </button>
          </div>
          <p class="text-muted" style="margin-top: var(--spacing-md); font-size: 0.875rem;">
            Deleting your account will permanently remove all your data, including training sessions, progress, and friend connections. This action cannot be undone.
          </p>
        </div>
      </div>
    </section>
    <section id="tab-sessions" class="tab-content">
      <h2 class="section-title">Training</h2>

      <!-- Sub-tabs for Sessions/Events -->
      <div class="sub-tabs">
        <button class="sub-tab-btn active" data-subtab="sessions-list-tab">
          <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M12 6a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/><path d="M4 22c2-2.5 4-4 6-4 1.5 0 2.5.5 4 1.5 1.5 1 2.5 1.5 4 1.5 2 0 4-1.5 6-4"/><path d="M4 17c2-2.5 4-4 6-4 1.5 0 2.5.5 4 1.5 1.5 1 2.5 1.5 4 1.5 2 0 4-1.5 6-4"/></svg>
          Sessions
        </button>
        <button class="sub-tab-btn" data-subtab="events-list-tab">
          <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><circle cx="12" cy="15" r="2"/></svg>
          Events
        </button>
      </div>

      <!-- Sessions Sub-tab -->
      <div id="sessions-list-tab" class="sub-tab-content active">
        <div class="card">
          <div class="card-header">
            <h3>All Sessions</h3>
            <div class="card-header-actions">
              <button id="add-session-btn" class="btn btn-primary btn-small">
                <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Add
              </button>
              <button id="sessions-import-btn" class="btn btn-secondary btn-small">
                <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                Import
              </button>
              <button id="sessions-export-btn" class="btn btn-secondary btn-small">
                <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Export
              </button>
            </div>
          </div>
          <div class="card-body">
            <div id="sessions-list"></div>
          </div>
        </div>
      </div>

      <!-- Events Sub-tab -->
      <div id="events-list-tab" class="sub-tab-content">
        <div class="card">
          <div class="card-header">
            <h3>Upcoming Events</h3>
            <div class="card-header-actions">
              <button id="add-event-btn" class="btn btn-primary btn-small">
                <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Add Event
              </button>
            </div>
          </div>
          <div class="card-body">
            <div id="events-list"></div>
          </div>
        </div>

        <!-- Past Events -->
        <div class="card">
          <div class="card-header">
            <h3>Past Events</h3>
          </div>
          <div class="card-body">
            <div id="past-events-list"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Session Form Modal -->
    <div class="modal-overlay" id="session-modal" style="display: none;">
      <div class="modal">
        <div class="modal-header">
          <h3 id="session-form-title">Log New Session</h3>
          <button type="button" class="modal-close-btn" id="session-form-close-btn">
            <svg class="icon icon-outline" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <div class="modal-body">
          <form id="session-form">
            <input type="hidden" id="edit-session-id" value="">

            <div class="form-row">
              <div class="form-group">
                <label for="sessionDate">
                  <svg class="icon icon-outline" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                  Date
                </label>
                <input type="date" id="sessionDate" name="sessionDate" required>
              </div>
              <div class="form-group">
                <label for="sessionType">
                  <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M2 12c2-2 4-3 6-3s4 1 6 3 4 3 6 3 4-1 6-3"/><path d="M2 6c2-2 4-3 6-3s4 1 6 3 4 3 6 3 4-1 6-3"/><path d="M2 18c2-2 4-3 6-3s4 1 6 3 4 3 6 3 4-1 6-3"/></svg>
                  Type
                </label>
                <select id="sessionType" name="sessionType" required>
                  <option value="pool">Pool</option>
                  <option value="open_water">Open Water</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="sessionDistance">
                  <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M16 4h2a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-2"/><path d="M8 20H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 4v16"/></svg>
                  Distance (meters)
                </label>
                <input type="number" id="sessionDistance" name="sessionDistance" min="0" step="1" required>
              </div>
              <div class="form-group">
                <label for="sessionTime">
                  <svg class="icon icon-outline" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  Time (minutes)
                </label>
                <input type="number" id="sessionTime" name="sessionTime" min="0" step="0.1" required>
              </div>
            </div>

            <div class="form-group">
              <label>
                <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M6.5 6.5a2.5 2.5 0 0 1 5 0v11a2.5 2.5 0 0 1-5 0v-11z"/><path d="M12.5 6.5a2.5 2.5 0 0 1 5 0v11a2.5 2.5 0 0 1-5 0v-11z"/></svg>
                How did it feel?
              </label>
              <input type="hidden" id="sessionRPE" name="sessionRPE" value="moderate">
              <div class="effort-selector">
                <button type="button" class="effort-btn" data-effort="easy">
                  <span class="effort-icon">ðŸ˜Š</span>
                  <span class="effort-label">Easy</span>
                </button>
                <button type="button" class="effort-btn active" data-effort="moderate">
                  <span class="effort-icon">ðŸ’ª</span>
                  <span class="effort-label">Moderate</span>
                </button>
                <button type="button" class="effort-btn" data-effort="hard">
                  <span class="effort-icon">ðŸ”¥</span>
                  <span class="effort-label">Hard</span>
                </button>
              </div>
            </div>

            <div class="form-group">
              <label for="sessionNotes">Notes (optional)</label>
              <textarea id="sessionNotes" name="sessionNotes" rows="2" placeholder="How did it feel? Any technique focus?"></textarea>
            </div>

            <div class="form-group">
              <label for="sessionConditions">Conditions (optional)</label>
              <input type="text" id="sessionConditions" name="sessionConditions" placeholder="e.g., 20Â°C, slight chop, clear water">
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary btn-large" id="session-submit-btn">Log Session</button>
              <button type="button" class="btn btn-secondary btn-large" id="session-cancel-btn">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="import-modal" style="display: none;">
      <div class="modal">
        <div class="modal-header">
          <h3>Import Sessions</h3>
          <button type="button" class="modal-close-btn" id="import-modal-close-btn">
            <svg class="icon icon-outline" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-lg">Import swimming sessions from Samsung Health or other fitness apps.</p>

          <div class="import-option">
            <h4>Samsung Health Export</h4>
            <p class="text-muted">Upload a CSV file exported from Samsung Health app.</p>
            <input type="file" id="samsung-import-file" accept=".csv" style="display: none;">
            <button type="button" class="btn btn-primary" id="samsung-import-btn">
              <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Select Samsung Health CSV
            </button>
          </div>

          <div class="import-option">
            <h4>GPX File (Samsung Health / Garmin)</h4>
            <p class="text-muted">Upload a GPX file exported from Samsung Health, Garmin, or other fitness apps.</p>
            <input type="file" id="gpx-import-file" accept=".gpx" style="display: none;">
            <button type="button" class="btn btn-primary" id="gpx-import-btn">
              <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Select GPX File
            </button>
          </div>

          <div class="import-option">
            <h4>App Export</h4>
            <p class="text-muted">Upload a JSON file previously exported from this app.</p>
            <input type="file" id="app-import-file" accept=".json" style="display: none;">
            <button type="button" class="btn btn-secondary" id="app-import-btn">
              <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Select App JSON
            </button>
          </div>

          <div id="import-preview" class="import-preview" style="display: none;">
            <h4>Preview</h4>
            <p id="import-preview-count"></p>
            <div id="import-preview-list"></div>
            <div class="form-actions">
              <button type="button" class="btn btn-primary" id="confirm-import-btn">Import Sessions</button>
              <button type="button" class="btn btn-secondary" id="cancel-import-btn">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Event Form Modal -->
    <div class="modal-overlay" id="event-modal" style="display: none;">
      <div class="modal">
        <div class="modal-header">
          <h3 id="event-form-title">Add New Event</h3>
          <button type="button" class="modal-close-btn" id="event-form-close-btn">
            <svg class="icon icon-outline" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <div class="modal-body">
          <form id="event-form" novalidate>
            <input type="hidden" id="edit-event-id" value="">

            <div class="form-group">
              <label for="eventName">
                <svg class="icon icon-outline" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                Event Name
              </label>
              <input type="text" id="eventName" name="eventName" placeholder="e.g., Midmar Mile, 5K Open Water">
              <small>What's the event called?</small>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="eventDate">
                  <svg class="icon icon-outline" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                  Event Date
                </label>
                <input type="date" id="eventDate" name="eventDate">
              </div>
              <div class="form-group">
                <label for="eventDistance">
                  <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M16 4h2a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-2"/><path d="M8 20H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 4v16"/></svg>
                  Distance (meters)
                </label>
                <input type="number" id="eventDistance" name="eventDistance" min="100" step="1" value="1609">
                <small>1609m = 1 mile</small>
              </div>
            </div>

            <div class="form-group">
              <label for="eventGoal">
                <svg class="icon icon-outline" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                Your Goal
              </label>
              <select id="eventGoal" name="eventGoal">
                <option value="finish_comfortably">Finish comfortably</option>
                <option value="target_time">Target a specific time</option>
                <option value="personal_best">Beat my personal best</option>
                <option value="just_finish">Just finish (first time)</option>
              </select>
            </div>

            <div class="form-group" id="event-target-time-group" style="display: none;">
              <label for="eventTargetTime">
                <svg class="icon icon-outline" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                Target Time (MM:SS)
              </label>
              <input type="text" id="eventTargetTime" name="eventTargetTime" placeholder="45:00">
              <small>Format: MM:SS (e.g., 45:00 for 45 minutes)</small>
            </div>

            <div class="form-group">
              <label for="eventNotes">Notes (optional)</label>
              <textarea id="eventNotes" name="eventNotes" rows="2" placeholder="Any notes about this event..."></textarea>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary btn-large" id="event-submit-btn">Add Event</button>
              <button type="button" class="btn btn-secondary btn-large" id="event-cancel-btn">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Session Detail Modal -->
    <div class="modal-overlay" id="session-detail-modal" style="display: none;">
      <div class="modal modal-large">
        <div class="modal-header">
          <h3 id="session-detail-title">Session Details</h3>
          <button type="button" class="modal-close-btn" id="session-detail-close-btn">
            <svg class="icon icon-outline" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <div class="modal-body">
          <!-- Map container (only shown for sessions with GPS data) -->
          <div id="session-map-container" style="display: none;">
            <div id="session-map"></div>
            <div class="map-stats" id="map-stats"></div>
          </div>

          <!-- Session details -->
          <div class="session-detail-content" id="session-detail-content">
            <!-- Populated by JavaScript -->
          </div>

          <!-- Actions -->
          <div class="session-detail-actions">
            <button type="button" class="btn btn-secondary" id="session-detail-edit-btn">
              <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              Edit Session
            </button>
            <button type="button" class="btn btn-danger" id="session-detail-delete-btn">
              <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- SOCIAL TAB -->
    <!-- ============================================ -->
    <section id="tab-social" class="tab-content">
      <h2 class="section-title">Social</h2>

      <!-- Auth Status Banner -->
      <div id="auth-banner" class="auth-banner">
        <div class="auth-banner-content">
          <div class="auth-banner-icon">
            <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </div>
          <div class="auth-banner-text">
            <h3>Connect with Friends</h3>
            <p>Sign in to share your progress and compare with friends</p>
          </div>
        </div>
        <div class="auth-banner-actions">
          <button id="sign-in-google-btn" class="btn btn-primary">
            <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Sign in with Google
          </button>
          <button id="sign-in-email-btn" class="btn btn-secondary">
            <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            Sign in with Email
          </button>
        </div>
      </div>

      <!-- Signed In Content (hidden by default) -->
      <div id="social-content" style="display: none;">
        <!-- User Profile & Friend Code Combined -->
        <div class="card card-primary">
          <div class="card-header">
            <div class="social-user-header">
              <div class="social-user-avatar" id="social-user-avatar">
                <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              </div>
              <div class="social-user-info">
                <div class="social-user-name" id="social-user-name">--</div>
                <div class="sync-status" id="sync-status">
                  <span class="sync-dot synced"></span>
                  <span class="sync-text">Synced</span>
                </div>
              </div>
            </div>
            <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
              <!-- Mock data button - only visible in development -->
              <button id="toggle-mock-data-btn" class="btn btn-secondary btn-small dev-only" title="Toggle mock data for UI preview" style="display: none;">
                <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 14px; height: 14px;"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                <span id="mock-data-label">Show Mock</span>
              </button>
              <button id="open-add-friend-modal-btn" class="btn btn-primary">
                <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                Add Friend
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="friend-code-compact">
              <div>
                <label class="friend-code-label">Your Friend Code</label>
                <div class="friend-code-value" id="my-friend-code">------</div>
              </div>
              <div class="friend-code-actions">
                <button id="copy-friend-code-btn" class="btn-icon-labeled" title="Copy Code">
                  <svg class="icon icon-outline" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  <span>Copy</span>
                </button>
                <button id="show-qr-btn" class="btn-icon-labeled" title="Show QR Code">
                  <svg class="icon icon-outline" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/><rect x="18" y="14" width="3" height="3"/><rect x="14" y="18" width="3" height="3"/><rect x="18" y="18" width="3" height="3"/></svg>
                  <span>QR</span>
                </button>
                <button id="share-link-btn" class="btn-icon-labeled" title="Share Link">
                  <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                  <span>Share</span>
                </button>
              </div>
            </div>
            <div id="qr-code-container" class="qr-code-container" style="display: none;">
              <canvas id="qr-code-canvas"></canvas>
            </div>
          </div>
        </div>

        <!-- Social Tabs -->
        <div class="tab-navigation" style="margin-bottom: var(--spacing-lg);">
          <button class="social-tab-btn active" data-social-tab="compare">
            <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
            Compare
          </button>
          <button class="social-tab-btn" data-social-tab="leaderboard">
            <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
            Leaderboard
          </button>
          <button class="social-tab-btn" data-social-tab="friends">
            <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Friends
          </button>
        </div>

        <!-- Friends Tab Content -->
        <div id="social-tab-friends" class="social-tab-content" style="display: none;">
          <!-- Friend Requests -->
          <div class="card" id="friend-requests-card" style="display: none;">
            <div class="card-header">
              <h3>
                <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>
                Friend Requests
                <span class="badge" id="friend-requests-count">0</span>
              </h3>
            </div>
            <div class="card-body">
              <div id="friend-requests-list"></div>
            </div>
          </div>

          <!-- Friends List -->
          <div class="card">
            <div class="card-header">
              <h3>
                <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                My Friends
              </h3>
            </div>
            <div class="card-body">
              <div id="friends-list" class="friends-list">
                <div class="empty-state">
                  <p>No friends yet. Share your code to get started!</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Leaderboard Tab Content -->
        <div id="social-tab-leaderboard" class="social-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h3>
                <svg class="icon icon-outline" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                Weekly Leaderboard
              </h3>
            </div>
            <div class="card-body">
              <div id="leaderboard" class="leaderboard">
                <div class="empty-state">
                  <p>Add friends to see the leaderboard</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Compare Tab Content -->
        <div id="social-tab-compare" class="social-tab-content active" style="display: block;">
          <div class="card">
            <div class="card-header">
              <h3>
                <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
                How You Compare
              </h3>
              <a href="#" id="edit-permissions-link" class="btn-link" onclick="window.switchTab('profile'); return false;">Edit Permissions</a>
            </div>
            <div class="card-body">
              <!-- Prompt to add details (shown when age/sex not set) -->
              <div id="benchmark-prompt" class="benchmark-prompt" style="display: none;">
                <div class="empty-state">
                  <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 48px; height: 48px; margin-bottom: var(--spacing-md);"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
                  <p>Add your age and gender to see how you compare with swimmers like you</p>
                  <button onclick="window.switchTab('profile'); return false;" class="btn btn-primary">Complete Your Profile</button>
                </div>
              </div>

              <!-- Benchmark results (shown when age/sex are set) -->
              <div id="benchmark-content" style="display: none;">
                <div class="benchmark-filters">
                  <div class="benchmark-filter-info">
                    <span class="filter-label">Comparing with:</span>
                    <span class="filter-value" id="benchmark-filter-display">All swimmers</span>
                  </div>
                </div>
                <div id="benchmark-results" class="benchmark-results">
                  <div class="benchmark-stat">
                    <div class="benchmark-label">Your Weekly Distance</div>
                    <div class="benchmark-value" id="benchmark-my-distance">-- m</div>
                    <div class="benchmark-comparison" id="benchmark-distance-comparison">
                      <span class="benchmark-percentile">--</span>
                      <span class="benchmark-avg">Avg: -- m</span>
                    </div>
                  </div>
                  <div class="benchmark-stat">
                    <div class="benchmark-label">Your Current Streak</div>
                    <div class="benchmark-value" id="benchmark-my-streak">-- days</div>
                    <div class="benchmark-comparison" id="benchmark-streak-comparison">
                      <span class="benchmark-percentile">--</span>
                      <span class="benchmark-avg">Avg: -- days</span>
                    </div>
                  </div>
                </div>
                <p class="text-muted" style="margin-top: var(--spacing-md);">
                  <small>Based on anonymous data from swimmers who opted in.</small>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Email Sign In Modal -->
      <div class="modal-overlay" id="email-auth-modal" style="display: none;">
        <div class="modal">
          <div class="modal-header">
            <h3 id="modal-email-auth-title">Sign In with Email</h3>
            <button type="button" class="modal-close-btn" id="email-auth-close-btn">
              <svg class="icon icon-outline" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
          <div class="modal-body">
            <form id="modal-email-auth-form">
              <div class="form-group">
                <label for="modal-auth-email">Email</label>
                <input type="email" id="modal-auth-email" placeholder="you@example.com">
              </div>
              <div class="form-group">
                <label for="modal-auth-password">Password</label>
                <input type="password" id="modal-auth-password" placeholder="Password" minlength="6">
              </div>
              <div class="form-group" id="modal-auth-name-group" style="display: none;">
                <label for="modal-auth-display-name">Display Name</label>
                <input type="text" id="modal-auth-display-name" placeholder="Your name">
              </div>
              <div id="modal-auth-error" class="auth-error" style="display: none;"></div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary btn-large" id="modal-auth-submit-btn">Sign In</button>
              </div>
              <div class="auth-switch">
                <span id="modal-auth-switch-text">Don't have an account?</span>
                <button type="button" class="btn-link" id="auth-switch-btn">Sign Up</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Add Friend Modal -->
      <div class="modal-overlay" id="add-friend-modal" style="display: none;">
        <div class="modal">
          <div class="modal-header">
            <h3>Add a Friend</h3>
            <button type="button" class="modal-close-btn" id="add-friend-modal-close-btn">
              <svg class="icon icon-outline" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="add-friend-form">
              <div class="form-group">
                <label for="friend-code-input">Enter Friend Code</label>
                <div class="input-with-button">
                  <input type="text" id="friend-code-input" placeholder="ABC123" maxlength="6" style="text-transform: uppercase;">
                  <button id="add-friend-btn" class="btn btn-primary">Add Friend</button>
                </div>
              </div>
              <div class="divider-with-text">
                <span>or</span>
              </div>
              <button id="scan-qr-btn" class="btn btn-secondary btn-large">
                <svg class="icon icon-outline" viewBox="0 0 24 24" style="width: 18px; height: 18px;"><path d="M23 19a2 2 0 0 1-2 2h-3"/><path d="M21 14v-1"/><path d="M3 5a2 2 0 0 1 2-2h3"/><path d="M3 10V9"/><path d="M21 9a2 2 0 0 0-2-2h-3"/><path d="M21 19v1"/><path d="M3 19a2 2 0 0 0 2 2h3"/><path d="M3 14v1"/></svg>
                Scan QR Code
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- QR Scanner Modal -->
      <div class="modal-overlay" id="qr-scanner-modal" style="display: none;">
        <div class="modal">
          <div class="modal-header">
            <h3>Scan Friend's QR Code</h3>
            <button type="button" class="modal-close-btn" id="qr-scanner-close-btn">
              <svg class="icon icon-outline" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="qr-scanner-container">
              <video id="qr-scanner-video" autoplay playsinline></video>
              <div class="qr-scanner-overlay">
                <div class="qr-scanner-frame"></div>
              </div>
            </div>
            <p class="text-muted text-center">Point your camera at a friend's QR code</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ============================================ -->
    <!-- DATA TAB -->
    <!-- ============================================ -->
    <section id="tab-data" class="tab-content">
      <h2 class="section-title">Data Management</h2>

      <!-- Storage Info -->
      <div class="card">
        <div class="card-header">
          <h3>
            <svg class="icon icon-outline" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
            Storage Information
          </h3>
        </div>
        <div class="card-body">
          <p id="storage-info">Storage method: <strong id="storage-method">--</strong></p>
          <p class="text-muted">Your data syncs to the cloud when signed in. Use export to keep local backups.</p>
        </div>
      </div>

      <!-- Export Data -->
      <div class="card">
        <div class="card-header">
          <h3>Export Data</h3>
        </div>
        <div class="card-body">
          <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-md);">Download all your training data as a JSON file. Keep this file safe - it's your backup!</p>
          <button id="export-btn" class="btn btn-primary">
            <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Download Backup
          </button>
        </div>
      </div>

      <!-- Import Data -->
      <div class="card">
        <div class="card-header">
          <h3>Import Data</h3>
        </div>
        <div class="card-body">
          <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-md);">Restore your training data from a previously exported file.</p>

          <div class="form-group">
            <label for="import-strategy">Import Strategy</label>
            <select id="import-strategy">
              <option value="replace">Replace All (delete existing data, use imported data)</option>
              <option value="merge">Merge (combine with existing, keep newest sessions)</option>
            </select>
          </div>

          <div class="form-group">
            <label for="import-file">Choose File</label>
            <input type="file" id="import-file" accept=".json">
          </div>

          <button id="import-btn" class="btn btn-primary">
            <svg class="icon icon-outline" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            Import Backup
          </button>
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="card card-danger">
        <div class="card-header">
          <h3>
            <svg class="icon icon-outline" viewBox="0 0 24 24" style="color: var(--color-danger);"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            Danger Zone
          </h3>
        </div>
        <div class="card-body">
          <p style="color: var(--color-text-muted); margin-bottom: var(--spacing-md);"><strong>Warning:</strong> This will permanently delete all your data. Export a backup first!</p>
          <button id="clear-all-btn" class="btn btn-danger">
            <svg class="icon icon-outline" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            Clear All Data
          </button>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p>Let's Keep Swimming &copy; 2026</p>
    </div>
  </footer>

    </div> <!-- End main-app -->

<!-- Load JavaScript modules -->
  <script src="icons.js"></script>
  <script src="db.js"></script>
  <script src="prompts.js"></script>

  <!-- Coach modules (deterministic planning with LLM polish) -->
  <script src="coach/templates.js"></script>
  <script src="coach/planner.js"></script>
  <script src="coach/coachService.js"></script>
  <script src="coach/coachView.js"></script>

  <!-- Social modules (Firebase auth, sync, friends) -->
  <script src="auth.js"></script>
  <script src="landing.js"></script>
  <script src="profile.js"></script>
  <script src="sync.js"></script>
  <script src="social.js"></script>

  <script src="charts.js"></script>
  <script src="app.js"></script>

  <!-- Service Worker Registration & Update Detection -->
  <script>
    (function() {
      // Store for update state
      let newWorkerWaiting = null;
      let updateRequiresLogout = false;

      // Show update banner
      function showUpdateBanner(changelog, requiresLogout) {
        const banner = document.getElementById('update-banner');
        const changelogEl = document.getElementById('update-changelog');
        const btnText = document.getElementById('update-btn-text');

        if (!banner) return;

        updateRequiresLogout = requiresLogout;

        if (changelogEl && changelog) {
          changelogEl.textContent = changelog;
        }

        if (btnText) {
          btnText.textContent = requiresLogout ? 'Refresh & Sign In' : 'Refresh';
        }

        banner.style.display = 'block';
        // Trigger animation
        requestAnimationFrame(() => {
          banner.classList.add('visible');
        });
      }

      // Hide update banner
      function hideUpdateBanner() {
        const banner = document.getElementById('update-banner');
        if (banner) {
          banner.classList.remove('visible');
          setTimeout(() => {
            banner.style.display = 'none';
          }, 400);
        }
      }

      // Handle refresh
      function handleRefresh() {
        if (updateRequiresLogout && typeof Auth !== 'undefined' && Auth.signOut) {
          // Sign out first, then reload
          Auth.signOut().finally(() => {
            if (newWorkerWaiting) {
              newWorkerWaiting.postMessage({ type: 'SKIP_WAITING' });
            }
            window.location.reload();
          });
        } else {
          // Just reload
          if (newWorkerWaiting) {
            newWorkerWaiting.postMessage({ type: 'SKIP_WAITING' });
          }
          window.location.reload();
        }
      }

      // Check for version updates via fetch
      async function checkForUpdates() {
        try {
          // Fetch version.js with cache-busting
          const response = await fetch('/version.js?t=' + Date.now());
          const text = await response.text();

          // Extract version info
          const buildMatch = text.match(/build:\s*(\d+)/);
          const logoutMatch = text.match(/requiresLogout:\s*(true|false)/);
          const changelogMatch = text.match(/changelog:\s*['"]([^'"]+)['"]/);

          const serverBuild = buildMatch ? parseInt(buildMatch[1]) : 0;
          const requiresLogout = logoutMatch ? logoutMatch[1] === 'true' : false;
          const changelog = changelogMatch ? changelogMatch[1] : 'New features and improvements';

          // Compare with current version
          const currentBuild = window.APP_VERSION?.build || 0;

          if (serverBuild > currentBuild) {
            console.log(`ðŸ”„ Update available: build ${currentBuild} â†’ ${serverBuild}`);
            showUpdateBanner(changelog, requiresLogout);
          }
        } catch (error) {
          console.log('Version check failed:', error);
        }
      }

      // Initialize
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('âœ… Service Worker registered:', registration.scope);

              // Check for updates on registration
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    console.log('ðŸ”„ New service worker installed');
                    newWorkerWaiting = newWorker;

                    // Check version to get changelog and logout requirement
                    checkForUpdates();
                  }
                });
              });

              // Check for waiting service worker on page load
              if (registration.waiting) {
                newWorkerWaiting = registration.waiting;
                checkForUpdates();
              }

              // Periodically check for updates (every 5 minutes)
              setInterval(() => {
                registration.update();
              }, 5 * 60 * 1000);
            })
            .catch((error) => {
              console.log('âŒ Service Worker registration failed:', error);
            });

          // Listen for controller change (new SW activated)
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            // New service worker activated, reload if we triggered it
            if (newWorkerWaiting) {
              window.location.reload();
            }
          });
        });
      }

      // Set up banner button handlers
      document.addEventListener('DOMContentLoaded', () => {
        const dismissBtn = document.getElementById('update-dismiss-btn');
        const refreshBtn = document.getElementById('update-refresh-btn');

        if (dismissBtn) {
          dismissBtn.addEventListener('click', hideUpdateBanner);
        }

        if (refreshBtn) {
          refreshBtn.addEventListener('click', handleRefresh);
        }
      });
    })();
  </script>
</body>
</html>
